version: "3.8"

services:
  # Development container service
  dev:
    image: ghcr.io/stkr22/devcontainer-python-container:1.3.0@sha256:03811019a87d4c39e8f26871c3a7c5e99c14124242821c717abdd9a279528687
    container_name: web-ui-dev
    userns_mode: "keep-id"  # Podman: keeps your host UID
    working_dir: /workspaces/private-assistant-web-ui
    volumes:
      - ..:/workspaces/private-assistant-web-ui:rw,rprivate,rbind
    command: sleep infinity
    cap_add:
      - NET_RAW
    environment:
      # PostgreSQL connection (web-ui variables)
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: changethis
      POSTGRES_DB: app
      # MQTT connection
      MQTT_BROKER_HOST: mosquitto
      MQTT_BROKER_PORT: 1883
      MQTT_USERNAME: ""
      MQTT_PASSWORD: ""
      # MinIO connection
      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET_NAME: assistant-images
      MINIO_SECURE: "false"
      # FastAPI settings
      SECRET_KEY: changethis
      FRONTEND_HOST: http://localhost:5173
      ENVIRONMENT: local
      PROJECT_NAME: "Private Assistant Web UI"
      UV_WORKING_DIR: "/workspaces/private-assistant-web-ui/backend"
    depends_on:
      postgres:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      minio:
        condition: service_started
    networks:
      - pa-web-ui-network

  # PostgreSQL database for device registry and web-ui data
  postgres:
    image: docker.io/postgres:18.1-trixie
    container_name: web-ui-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: changethis
      POSTGRES_DB: app
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d app"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - pa-web-ui-network

  # Eclipse Mosquitto MQTT broker
  mosquitto:
    image: docker.io/eclipse-mosquitto:2.0.22@sha256:077fe4ff4c49df1e860c98335c77dda08360629e0e2a718147027e4db3eace9d
    container_name: web-ui-mosquitto
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -i healthcheck -W 3"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - pa-web-ui-network

  # MinIO object storage for images
  minio:
    image: quay.io/minio/minio:RELEASE.2025-09-07T16-13-09Z@sha256:14cea493d9a34af32f524e538b8346cf79f3321eff8e708c1e2960462bd8936e
    container_name: web-ui-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - pa-web-ui-network

networks:
  pa-web-ui-network:
    driver: bridge
